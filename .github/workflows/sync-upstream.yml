name: '_Sync to staging_'

on:
  schedule:
    - cron:  '6 23 * * *'

  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    permissions:
      contents: write
    if: github.repository_owner == 'vlaci'
    runs-on: ubuntu-latest
    name: Sync latest commits from upstream repo

    steps:
    - name: Checkout target repo
      uses: actions/checkout@v2
      with:
        ref:  master
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        fetch-depth: 0

    - name: Sync upstream changes
      run: |
        git config user.email "github-actions@github.com"
        git config user.name "Github Actions"
        git switch -C staging
        git fetch https://github.com/NixOS/nixpkgs nixos-unstable
        git rebase FETCH_HEAD || { git diff; exit 1; }
        if ! git diff --quiet --exit-code master..HEAD; then
          git push origin staging --force-with-lease
          echo "staging_updated=1" >> $GITHUB_ENV
        fi

    - name: Repository Dispatch
      if: ${{ env.staging_updated != '' }}
      uses: peter-evans/repository-dispatch@v2
      with:
        repository: vlaci/nixos-config
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        event-type: nixpkgs-update
